# Claude AI 开发约束规则

本文档定义了在数据仓库元数据管理系统开发过程中，Claude AI 需要遵守的规范和约束。

## 1. 代码规范约束

### 1.1 命名规范

- **类名**: 使用大驼峰命名法（PascalCase），如 `MetadataTableService`
- **方法名**: 使用小驼峰命名法（camelCase），如 `getMetadataById`
- **常量**: 使用全大写下划线分隔，如 `MAX_RETRY_COUNT`
- **包名**: 使用全小写，如 `com.datawarehouse.metadata.service`
- **变量名**: 使用小驼峰命名法，语义清晰，如 `metadataTable`

### 1.2 注释要求

- **类注释**: 必须包含类的功能说明、作者、版本信息
  ```java
  /**
   * 元数据表Service接口
   *
   * @author System
   * @since 1.0.0
   */
  ```
- **方法注释**: 公共方法必须添加JavaDoc注释，说明参数、返回值、异常
- **关键业务逻辑**: 必须添加行内注释说明
- **禁止**: 无意义的注释、注释掉的废弃代码（应删除）

### 1.3 代码风格

- **缩进**: 使用4个空格，禁止使用Tab
- **行宽**: 单行代码不超过120个字符
- **空行**: 方法之间保留一个空行，逻辑块之间适当添加空行
- **导入**: 禁止使用通配符导入（import xxx.*），按字母顺序排列
- **大括号**: 左大括号不换行，右大括号单独一行

### 1.4 代码质量

- 避免代码重复，遵循DRY原则（Don't Repeat Yourself）
- 单一职责原则，一个方法只做一件事
- 方法参数不超过5个，超过应封装为对象
- 循环嵌套不超过3层
- 使用Lombok简化代码，减少样板代码

## 2. 架构和设计约束

### 2.1 分层架构

严格遵循三层架构模式：

```
Controller层（控制层）
    ↓ 只能调用
Service层（业务层）
    ↓ 只能调用
Mapper层（数据访问层）
```

**禁止**:
- Controller 直接调用 Mapper
- 跨层调用（如 Mapper 调用 Service）
- 循环依赖

### 2.2 包结构规范

```
com.datawarehouse.metadata
├── controller      # 控制器层
├── service         # 服务接口
│   └── impl        # 服务实现
├── mapper          # 数据访问层
├── entity          # 实体类
├── dto             # 数据传输对象
├── vo              # 视图对象
├── config          # 配置类
├── common          # 通用类
├── exception       # 异常类
└── util            # 工具类
```

### 2.3 设计模式

- **优先使用**: 单例模式（Spring Bean）、工厂模式、策略模式、模板方法模式
- **谨慎使用**: 复杂的设计模式，避免过度设计
- **依赖注入**: 使用构造器注入（推荐）或@Autowired注入

### 2.4 技术选型限制

**必须使用的技术栈**:
- Spring Boot 2.7.x
- MyBatis Plus 3.5.x
- MySQL 8.0+
- Redis
- Knife4j (Swagger)

**禁止引入**:
- 未经批准的新框架或库
- 过时的技术（如 Struts、JSP）
- 重复功能的库（已有MyBatis Plus，不应引入JPA）

## 3. 开发流程约束

### 3.1 分支管理

- **master/main**: 生产环境分支，受保护，仅通过PR合并
- **develop**: 开发主分支
- **feature/xxx**: 功能开发分支，从develop分出
- **bugfix/xxx**: Bug修复分支
- **hotfix/xxx**: 紧急修复分支，从master分出

### 3.2 提交规范

提交信息格式：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型**:
- `feat`: 新功能
- `fix`: Bug修复
- `refactor`: 重构
- `docs`: 文档更新
- `style`: 代码格式调整
- `test`: 测试相关
- `chore`: 构建/工具变动

**示例**:
```
feat(metadata): 添加元数据字段管理功能

- 新增MetadataField实体类
- 实现字段的CRUD操作
- 添加字段类型枚举

Closes #123
```

### 3.3 测试要求

- **单元测试**: 核心业务逻辑必须编写单元测试，覆盖率不低于70%
- **集成测试**: 重要接口必须编写集成测试
- **测试数据**: 使用独立的测试数据库，不影响开发/生产环境
- **测试命名**: `test方法名_场景_预期结果`，如 `testGetById_WhenIdExists_ReturnData`

### 3.4 代码审查

- 所有代码必须通过Code Review后才能合并到主分支
- 自测通过后再提交PR
- PR描述清晰，说明改动内容和测试情况

## 4. 安全和性能约束

### 4.1 安全编码规范

**SQL注入防护**:
- 必须使用MyBatis Plus的参数化查询
- 禁止拼接SQL语句
- 动态SQL使用`#{}`而非`${}`

**XSS防护**:
- 前端输入必须进行校验和转义
- 使用@Valid注解进行参数校验

**敏感信息**:
- 禁止在代码中硬编码密码、密钥
- 敏感配置使用环境变量或配置中心
- 日志中不输出敏感信息（密码、身份证号等）

**权限控制**:
- 所有接口必须进行权限校验（后续实现）
- 遵循最小权限原则

### 4.2 性能优化要求

**数据库操作**:
- 避免N+1查询，使用批量查询或关联查询
- 大数据量查询必须分页，禁止一次性查询全部数据
- 合理使用索引，查询条件字段必须有索引
- 慎用模糊查询，避免前缀通配符`%xxx`

**缓存使用**:
- 热点数据必须使用Redis缓存
- 设置合理的过期时间，避免缓存穿透
- 缓存更新采用主动更新策略

**并发控制**:
- 高并发场景使用乐观锁或分布式锁
- 避免长事务，事务粒度尽可能小

**代码性能**:
- 循环中避免重复创建对象
- 使用StringBuilder拼接字符串
- 集合初始化指定容量
- 避免过度使用反射

### 4.3 异常处理

- 使用统一的异常处理器 `GlobalExceptionHandler`
- 业务异常使用 `BusinessException`
- 异常信息对用户友好，对开发者有诊断价值
- 记录异常日志，包含堆栈信息

### 4.4 日志规范

- **日志级别**:
  - ERROR: 系统错误，需要立即处理
  - WARN: 警告信息，潜在问题
  - INFO: 关键业务流程
  - DEBUG: 调试信息，生产环境关闭

- **日志内容**:
  - 记录关键参数和返回值
  - 包含业务标识（如订单号、用户ID）
  - 避免日志过多影响性能

## 5. API设计约束

### 5.1 RESTful规范

- **URL设计**: 使用名词复数，如 `/api/metadata/tables`
- **HTTP方法**:
  - GET: 查询
  - POST: 新增
  - PUT: 全量更新
  - PATCH: 部分更新
  - DELETE: 删除

- **状态码**:
  - 200: 成功
  - 201: 创建成功
  - 400: 客户端错误（参数错误）
  - 401: 未认证
  - 403: 无权限
  - 404: 资源不存在
  - 500: 服务器错误

### 5.2 响应格式

统一使用 `Result<T>` 包装响应：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1234567890
}
```

### 5.3 接口文档

- 所有接口必须添加Swagger注解
- 参数和返回值说明完整
- 提供请求示例

## 6. 数据库设计约束

### 6.1 表设计规范

- 表名使用小写下划线分隔，如 `metadata_table`
- 字段名使用小写下划线分隔，如 `create_time`
- 主键统一使用 `id`，自增长
- 必须包含 `create_time`、`update_time` 字段
- 软删除使用 `deleted` 字段（0未删除，1已删除）
- 创建人/修改人字段: `create_by`、`update_by`

### 6.2 索引规范

- 主键自动创建索引
- 频繁查询的字段添加索引
- 联合索引遵循最左前缀原则
- 索引命名: `idx_字段名` 或 `idx_字段1_字段2`

### 6.3 数据类型选择

- 主键: `BIGINT`
- 时间: `DATETIME`
- 金额: `DECIMAL`
- 状态: `TINYINT` 或 `VARCHAR`
- 长文本: `TEXT`
- 避免使用 `BLOB` 存储大文件

## 7. 配置管理约束

### 7.1 配置文件

- 开发环境: `application-dev.yml`
- 测试环境: `application-test.yml`
- 生产环境: `application-prod.yml`
- 公共配置: `application.yml`

### 7.2 敏感配置

- 数据库密码、Redis密码等敏感信息不提交到Git
- 使用配置中心或环境变量管理
- 提供配置模板文件 `application-example.yml`

## 8. 禁止事项清单

**严格禁止**:
1. ❌ 直接修改生产环境数据库
2. ❌ 提交包含密码、密钥的代码
3. ❌ 注释掉的代码提交到仓库
4. ❌ 使用 `System.out.println()` 调试，应使用日志
5. ❌ 捕获异常后不处理（空catch块）
6. ❌ 硬编码魔法数字，应定义常量
7. ❌ 在循环中执行数据库操作
8. ❌ 返回null，应返回空对象或Optional
9. ❌ 过度使用static，除非确实需要
10. ❌ 在finally块中使用return

## 9. 优先级和例外

### 9.1 约束优先级

1. **P0 (必须遵守)**: 安全规范、SQL注入防护、敏感信息保护
2. **P1 (强烈建议)**: 分层架构、代码规范、测试要求
3. **P2 (建议遵守)**: 性能优化、日志规范、注释规范

### 9.2 例外申请

特殊情况需要违反约束时：
1. 在代码中添加注释说明原因
2. 在PR中详细说明
3. 获得Team Leader批准

## 10. 文档约束

### 10.1 CLAUDE必须遵循的要求
- CLAUDE每次进入项目必读，必须遵循的要求！
- CLAUDE每次进入项目必读，必须遵循的要求！
- 需要按照以下路径读取关键文档
- 请严格按照关键文档约束进行系统开发

| 文档类型 | 路径 | 用途 |
|---------|-------|----------|
| 需求文档 | claude/REQUIREMENT.md  | 了解业务需求 |
| 架构设计 | claude/Architecture.MD | 理解系统架构 |
| 工作约束 | claude/CLAUDE.md | 遵循开发规范 |
| 项目结构 | claude/PROJECT_STRUCTURE.md | 快速定位文件 |
| 实现指南 | claude/REALTIME_IMPLEMENTATION_GUIDE.md | 查看已实现功能 |
| 验证指南 | claude/BROWSER_VERIFICATION_GUIDE.md | 进行功能验证 |

### 10.2 生成文档要求
- ✅ 请先理解输入需求和需求文档，做好系统改动规划，修改架构设计文档，做好深度思考
- ✅ 需要改动系统请先更新架构设计文档（claude/Architecture.MD）
- ✅ 需要改动系统请先更新项目结构文档（claude/PROJECT_STRUCTURE.md）
- ✅ 需要改动系统请先更新实现指南文档（claude/PROJECT_STRUCTURE.md）
- ✅ 系统设计文档，说明文档请放置到项目根目录下的claude目录
- ✅ 相关运行脚本请放置到项目根目录下的bin目录，做好说明
- ✅ 系统改动完成，验证完毕更新验证指南文档（claude/BROWSER_VERIFICATION_GUIDE.md）

### 10.3 文档禁止事项
- ❌ 禁止改动需求文档（claude/REQUIREMENT.md）
- ❌ 禁止将生成的md文档放置在项目根目录下，应该放置到项目下的claude目录
- ❌ 禁止随意改动工作约束文档（claude/CLAUDE.md），改动前请确认

## 11. 更新记录

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 1.0.0 | 2026-01-10 | 初始版本 | System |

---

**注意**: 本文档会持续更新，所有开发人员（包括AI助手）都必须严格遵守以上约束。如有疑问或建议，请及时沟通。
